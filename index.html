<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9‰∏ã2-1.1Ë™çË≠òÁ∂≤Ë∑Ø(Á∂≤Ë∑ØÁöÑÈÄ£Êé•) - ÊïôÂ≠∏Êï∏ÊìöÁÆ°ÁêÜÁâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --macaron-pink: #FFB7B2;
            --macaron-orange: #FFDAC1;
            --macaron-yellow: #FFF9B1;
            --macaron-green: #B5EAD7;
            --macaron-blue: #C7CEEA;
            --macaron-purple: #E0BBE4;
            --macaron-mint: #E2F0CB;
        }

        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #fff1f2;
            overflow-x: hidden;
        }

        .main-card {
            max-width: 1000px;
            min-height: 85vh;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(244, 114, 182, 0.1);
        }

        .macaron-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: grab;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            pointer-events: auto !important;
        }
        
        .macaron-btn * { pointer-events: none; }
        .macaron-btn:active { cursor: grabbing; transform: scale(0.95); }

        .q1-btn-style {
            width: 155px !important;
            height: 52px !important; 
            padding-left: 0.5rem !important; 
            padding-right: 0.5rem !important; 
        }

        .q-compact-label {
            width: 92% !important; 
            padding-left: 0.75rem !important; 
            padding-right: 0.75rem !important; 
            white-space: normal !important; 
            min-height: 3rem !important; 
            font-size: 1rem !important;
            display: flex;
            align-items: center;
            line-height: 1.4;
            border-radius: 12px;
        }

        .slot {
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            background: white;
            border: 2px dashed rgba(0, 0, 0, 0.05);
            font-weight: bold;
            position: relative;
            pointer-events: none; 
            width: 100%;
        }

        .q1-slot-style {
            height: 52px !important;
            min-width: 155px !important;
            background-color: #f0f9ff !important; 
            border: 2px dashed #bae6fd !important;
        }

        .q-fixed-height-slot {
            height: 52px !important;
            min-height: 52px !important;
            border-radius: 12px !important;
        }

        .q3-slot-inline {
            width: auto !important;
            min-width: 160px !important;
            margin: 0 4px;
            display: inline-flex;
        }

        .q56-fixed-left { background-color: #fee2e2 !important; color: #ef4444 !important; border-color: #fecaca !important; }
        .q56-fixed-right { background-color: #dcfce7 !important; color: #22c55e !important; border-color: #bbf7d0 !important; }

        .drop-target-box {
            transition: all 0.3s ease;
            position: relative;
            pointer-events: auto;
        }
        
        .drop-target-box.drag-over {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            filter: brightness(1.05);
        }

        button, .choice-card, .progress-circle { pointer-events: auto; }
        button *, .choice-card *, .progress-circle * { pointer-events: none; }

        .progress-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background-color: white;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
            cursor: pointer;
        }
        .progress-circle:hover:not(.passed) { border-color: #f472b6; color: #f472b6; transform: scale(1.1); }
        .progress-circle.active { border-color: #f472b6; background-color: #fff1f2; color: #f472b6; box-shadow: 0 0 10px rgba(244, 114, 182, 0.2); }
        .progress-circle.passed {
            background-color: #f472b6;
            border-color: #f472b6;
            color: white;
            cursor: not-allowed; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .correct-hint { border: 4px solid #4ade80 !important; }
        .error-hint { border: 4px solid #f87171 !important; animation: shake 0.4s ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .choice-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 4px solid transparent;
        }
        .choice-card:hover { transform: translateY(-5px); filter: brightness(1.02); }
        .choice-card.selected { border-color: #f472b6; box-shadow: 0 0 15px rgba(244, 114, 182, 0.3); }
        
        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1); }
        }
        .winner-anim { animation: celebrate 0.5s ease infinite; }

        .color-0 { background-color: var(--macaron-pink); }
        .color-1 { background-color: var(--macaron-orange); }
        .color-2 { background-color: var(--macaron-yellow); }
        .color-3 { background-color: var(--macaron-green); }
        .color-4 { background-color: var(--macaron-blue); }
        .color-5 { background-color: var(--macaron-purple); }
        .color-6 { background-color: var(--macaron-mint); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="quiz-app" class="main-card bg-white w-full flex flex-col relative overflow-hidden">
        
        <header class="p-6 md:p-8 flex flex-wrap gap-4 justify-between items-center bg-pink-50/50">
            <div class="flex flex-col">
                <div class="flex items-center flex-wrap gap-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-pink-500 text-balance">üåê 9‰∏ã2-1.1Ë™çË≠òÁ∂≤Ë∑Ø(Á∂≤Ë∑ØÁöÑÈÄ£Êé•)</h1>
                    <div id="status-indicators" class="flex gap-2 ml-2"></div>
                </div>
                <p class="text-gray-400 text-sm mt-1">‰ΩúÁ≠îÈÄ≤Â∫¶: <span id="progress-text" class="font-bold text-pink-400"></span></p>
            </div>
            <div id="timer" class="text-xl font-bold text-gray-600 bg-white px-4 py-1 rounded-full shadow-sm">00:00</div>
        </header>

        <main id="question-container" class="flex-grow p-6 md:p-10 overflow-y-auto">
            <!-- È°åÁõÆÁî± JS Ê≥®ÂÖ• -->
        </main>

        <footer class="p-6 md:p-8 bg-gray-50 flex flex-wrap gap-4 justify-between items-center relative z-[200]">
            <button id="prev-btn" class="px-6 py-2 rounded-full border-2 border-pink-200 text-pink-400 font-bold hover:bg-pink-100 disabled:opacity-30 transition-all">
                ‰∏ä‰∏ÄÈ°å
            </button>
            
            <div class="flex items-center gap-4">
                <button id="check-btn" class="px-8 py-3 bg-pink-500 text-white rounded-full font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-all active:scale-95">
                    Ê™¢Êü•Á≠îÊ°à
                </button>
                <button id="next-btn" class="px-6 py-2 rounded-full bg-indigo-400 text-white font-bold hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-100">
                    ‰∏ã‰∏ÄÈ°å
                </button>
            </div>
        </footer>

        <!-- Ëá™ÂÆöÁæ©ÂΩàÁ™ó (Modal) -->
        <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[300] flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform scale-90 transition-transform duration-300" id="modal-content">
                <div class="text-4xl mb-4 text-center" id="modal-icon">üí°</div>
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 text-center mb-2">ÊèêÈÜí</h3>
                <p id="modal-message" class="text-gray-600 text-center mb-6 leading-relaxed"></p>
                <div class="flex gap-4 justify-center">
                    <button id="modal-cancel-btn" onclick="closeModal()" class="px-6 py-2 border-2 border-gray-200 text-gray-400 font-bold rounded-full hover:bg-gray-50 transition-all active:scale-95">ËøîÂõû</button>
                    <button id="modal-confirm-btn" class="px-6 py-2 bg-pink-500 text-white font-bold rounded-full hover:bg-pink-600 transition-all active:scale-95 shadow-lg shadow-pink-100">Á¢∫Ë™ç</button>
                </div>
            </div>
        </div>

        <div id="result-overlay" class="absolute inset-0 bg-white z-[500] flex flex-col items-center justify-start p-6 md:p-10 hidden fade-in overflow-y-auto pt-10">
            <div class="border-4 border-pink-200 rounded-3xl p-8 max-w-3xl w-full bg-white shadow-xl my-4 relative shrink-0">
                <div class="flex items-center justify-center gap-4 mb-6 flex-wrap">
                    <h2 class="text-3xl font-bold text-pink-500 text-center text-balance">üìù Ê∏¨È©óÊåëÊà∞ÁµêÊûú</h2>
                    <span class="bg-pink-100 text-pink-500 px-4 py-1 rounded-full font-black tracking-widest text-lg border border-pink-200" id="display-random-id"></span>
                </div>
                
                <div id="final-stats" class="space-y-4 mb-8"></div>
                
                <div class="mb-8">
                    <h4 class="text-gray-500 text-sm font-bold mb-4 flex items-center gap-2">
                        <span class="w-1 h-4 bg-pink-400 rounded-full"></span> ÂêÑÈ°åÂòóË©¶Ê¨°Êï∏Áµ±Ë®à
                    </h4>
                    <div id="check-breakdown" class="grid grid-cols-4 md:grid-cols-8 gap-2"></div>
                </div>

                <div class="bg-pink-50 p-6 rounded-2xl text-center border border-pink-100">
                    <div id="quote-zh" class="text-xl font-bold text-pink-600 mb-3 text-balance"></div>
                    <div id="quote-en" class="text-base italic text-pink-400 leading-relaxed text-balance"></div>
                </div>
            </div>
            <div class="flex justify-center mt-2 mb-10">
                <button id="restart-btn" class="px-12 py-4 bg-pink-500 text-white rounded-full text-xl font-bold shadow-xl hover:bg-pink-600 transition-all active:scale-95 shrink-0">ÈáçÊñ∞ÊåëÊà∞</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full bg-gray-800 text-white font-bold opacity-0 transition-opacity pointer-events-none z-[600] text-xl shadow-lg"></div>

    <script>
        const gasUrl = "https://script.google.com/macros/s/AKfycbyzKkCUbmOBjv-tHfPfEPFioNKAbYtDf74BR176NSC0EOMxwadic7ahUGOirXpCVazDHA/exec"; 

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        const quizData = [
            {
                type: 'matching_fixed',
                question: "Ë´ãÊ†πÊìöÁ∂≤Ë∑ØÁôºÂ±ïÂè≤ÔºåÁî±ÈÅ†Âà∞ËøëÊéíÂàóÊ≠£Á¢∫ÁöÑÈ†ÜÂ∫èÔºö",
                options: ["ARPANET", "TCP/IP", "Á∂≤ÂüüÂêçÁ®±ÊúçÂãô", "ÁÄèË¶ΩÂô®+WWW", "TANet"],
                steps: [
                    { type: 'slot', answer: "ARPANET", desc: "Ëß£Ê±∫Êà∞ÊôÇÈÄöË®äË¢´ÈòªÊñ∑ÁöÑÂç±Ê©ü" },
                    { type: 'slot', answer: "TCP/IP", desc: "Ëß£Ê±∫‰∏çÂêåÈõªËÖ¶Á≥ªÁµ±ÈÄöË®äÂõ∞Â¢É" },
                    { type: 'slot', answer: "Á∂≤ÂüüÂêçÁ®±ÊúçÂãô", desc: "Ëß£Ê±∫IP‰∏çÊòìË®òÊÜ∂ÂïèÈ°å" },
                    { type: 'slot', answer: "ÁÄèË¶ΩÂô®+WWW", desc: "ËÆìÁ∂≤Ë∑ØË≥áÊñôËÉΩÊõ¥Â§öÂÖÉÂåñ" },
                    { type: 'slot', answer: "TANet", desc: "Ëá∫ÁÅ£Â≠∏Ë°ìÁ∂≤Ë∑ØËµ∑Èªû" }
                ],
                forceColor: true,
                shuffleOnError: true,
                isQuestionOne: true 
            },
            {
                type: 'multiple_choice',
                question: "Ë´ãÂïèË™∞ÁôºÊòé‰∫Ü„ÄåÁ∂≤È†ÅÁÄèË¶ΩÂô®„ÄçÈÄ≤ËÄåÊé®Âãï‰∫Ü„ÄåÂÖ®ÁêÉË≥áË®äÁ∂≤„ÄçÁöÑÂΩ¢ÊàêÔºü",
                correct: "ÊüèÁ¥çÔºéÊùé",
                options: [
                    { text: "ÊüèÁ¥çÔºéÊùé", icon: "üßî" },
                    { text: "ÊØîÁàæÔºéËìãËå≤", icon: "üßë‚Äçü¶≥" },
                    { text: "‰ºäÈöÜ¬∑È¶¨ÊñØÂÖã", icon: "üßë" },
                    { text: "È¶¨ÂÖã¬∑Á•ñÂÖãÊüè", icon: "üë®‚Äçü¶±" }
                ]
            },
            {
                type: 'drag_and_drop_slot', 
                question: "Ë´ãÂ°´ÂÖ•Ê≠£Á¢∫ÁöÑÁ∂≤Ë∑ØÂÆöÁæ©ÊïòËø∞Ôºö",
                parts: ["„ÄåÁ∂≤Ë∑Ø„ÄçÊòØÈÄèÈÅéÊúâÁ∑öÊàñÁÑ°Á∑öÁöÑ", "ÔºåÂ∞áË®±Â§öÈõªËÖ¶ÊàñÁ°¨È´îË®≠ÂÇô", "Ëµ∑‰æÜÔºåËÆìÂΩºÊ≠§ÂèØ‰ª•‰∫íÁõ∏", "ÁöÑÊäÄË°ì„ÄÇ"],
                blanks: ["ÂÇ≥Ëº∏Â™í‰ªã", "ÈÄ£Êé•", "ÂÇ≥ÈÅûË≥áË®ä"],
                options: ["ÂÇ≥Ëº∏Â™í‰ªã", "ÈÄ£Êé•", "ÂÇ≥ÈÅûË≥áË®ä"],
                forceColor: true,
                shuffleOnError: true,
                isQuestionThree: true
            },
            {
                type: 'matching_list',
                question: "Ë´ãÂ∞á‰∏ãÂàó‰∏≠Ëã±ÊñáÂêçË©ûÈÄ≤Ë°åÊ≠£Á¢∫ÈÖçÂ∞çÔºö",
                items: [
                    { label: "Á∂≤Ë∑Ø", answer: "Network" },
                    { label: "ÂÖ®ÁêÉÁ¨¨‰∏ÄÂÄãÁ∂≤Ë∑Ø", answer: "ARPANET" },
                    { label: "Á∂≤Ë∑ØÈÄöË®äÂçîÂÆö", answer: "TCP/IP" },
                    { label: "ÂÖ®ÁêÉË≥áË®äÁ∂≤Á∞°Á®±", answer: "WWW" },
                    { label: "Ëá∫ÁÅ£Â≠∏Ë°ìÁ∂≤Ë∑Ø", answer: "TANet" },
                    { label: "Á∂≤Ë∑ØÊúçÂãôÊèê‰æõËÄÖ", answer: "ISP" }
                ],
                options: ["Network", "ARPANET", "TCP/IP", "WWW", "TANet", "ISP"],
                randomPos: true,
                customColorGroups: true,
                shuffleOnError: true,
                isQuestionFour: true,
                isThreeColumns: true 
            },
            {
                type: 'matching_fixed',
                question: "Ë´ãÁî±„ÄåÊÖ¢„ÄçÂà∞„ÄåÂø´„ÄçÊéíÂàóÊúâÁ∑öÂÇ≥Ëº∏Â™í‰ªãÈÄüÂ∫¶Ôºö",
                options: ["ÈõôÁµûÁ∑ö", "ÂêåËª∏ÈõªÁ∫úÁ∑ö", "ÂÖâÁ∫ñ"],
                steps: [
                    { type: 'fixed', name: "ÊÖ¢" },
                    { type: 'slot', answer: "ÈõôÁµûÁ∑ö" },
                    { type: 'slot', answer: "ÂêåËª∏ÈõªÁ∫úÁ∑ö" },
                    { type: 'slot', answer: "ÂÖâÁ∫ñ" },
                    { type: 'fixed', name: "Âø´" }
                ],
                forceColor: true,
                shuffleOnError: true,
                isFixedSlotQuestion: true,
                isQuestionFiveSix: true
            },
            {
                type: 'matching_fixed',
                question: "Ë´ã‰æùÂÇ≥Ëº∏Ë∑ùÈõ¢„ÄåÈÅ†„ÄçÂà∞„ÄåËøë„ÄçÊéíÂàóÊúâÁ∑öÂÇ≥Ëº∏Â™í‰ªãÔºö",
                options: ["ÂÖâÁ∫ñ", "ÂêåËª∏ÈõªÁ∫úÁ∑ö", "ÈõôÁµûÁ∑ö"],
                steps: [
                    { type: 'fixed', name: "ÈÅ†" },
                    { type: 'slot', answer: "ÂÖâÁ∫ñ" },
                    { type: 'slot', answer: "ÂêåËª∏ÈõªÁ∫úÁ∑ö" },
                    { type: 'slot', answer: "ÈõôÁµûÁ∑ö" },
                    { type: 'fixed', name: "Ëøë" }
                ],
                forceColor: true,
                shuffleOnError: true,
                isFixedSlotQuestion: true,
                isQuestionFiveSix: true
            },
            {
                type: 'matching_list',
                question: "Ë´ãÊ†πÊìöÁí∞Â¢ÉË™™ÊòéÈÅ∏ÊìáÈÅ©ÂêàÁöÑÂÇ≥Ëº∏Â™í‰ªãÔºö",
                items: [
                    { label: "ÊúãÂèãÂÄü‰ΩèÂÆ∂Ë£°‰∫åÊ®ìÂÖ©Â§©ÔºåÊúâ‰∏äÁ∂≤ÁöÑÈúÄÊ±ÇÔºå‰ΩÜ‰∫åÊ®ìÊ≤íÊúâÁ∂≤Ë∑ØÔºåÊúÄËøëÁöÑÁ∂≤Ë∑ØË®≠ÂÇôÂú®‰∏âÊ®ìÔºåÈÄüÂ∫¶‰∏çË¶ÅÊ±ÇÔºåÂèØ‰ª•‰∏äÁ∂≤Â∞±Â•Ω", answer: "ÈõôÁµûÁ∑ö" },
                    { label: "ËÄÅÈóÜÊÉ≥Âú®Â∑•Âª†Ëæ¶ÂÖ¨ÂÆ§Áõ¥Á∑ö50ÂÖ¨Â∞∫ËôïÔºåÂÜçÂ¢ûÂä†‰∏ÄÈñìËæ¶ÂÖ¨ÂÆ§ÔºåÁ∂≤Ë∑ØË¶ÅÂæûËàäËæ¶ÂÖ¨ÂÆ§ÊãâÈÅéÂéªÔºå‰ΩÜ‰ΩàÁ∑öË∑ØÂæëÊúÉÁ∂ìÈÅéÂæàÂ§öÈ´òÂäüÁéáÁöÑÊ©üÂô®", answer: "ÂêåËª∏ÈõªÁ∫úÁ∑ö" },
                    { label: "Ê†°Èï∑ÊÉ≥Âú®ÊìçÂ†¥Âè∏‰ª§Âè∞ÂÆâÊéí‰∏ÄÂÄãÂø´ÈÄüÂèàÁ©©ÂÆöÁöÑÁ∂≤Ë∑ØÁØÄÈªûÔºåÂÅöÁÇ∫ÂÖ∏Á¶ÆÊàñÈò≤ÁÅΩ‰ΩøÁî®Ôºå‰ΩÜÊúÄËøëÁöÑÁ∂≤Ë∑ØË®≠ÂÇôÂú®ÈõªËÖ¶ÊïôÂÆ§ÈöîÂ£ÅÁöÑÊ©üÊàø", answer: "ÂÖâÁ∫ñ" }
                ],
                options: ["ÈõôÁµûÁ∑ö", "ÂêåËª∏ÈõªÁ∫úÁ∑ö", "ÂÖâÁ∫ñ"],
                randomPos: true,
                shuffleOnError: true,
                isQuestionSeven: true, 
                isThreeColumns: true, 
                customColorGroups: true
            },
            {
                type: 'matching_list',
                question: "Ë´ãÊ†πÊìöÂäüËÉΩË™™ÊòéÔºåÈÖçÂ∞çÊ≠£Á¢∫ÁöÑÁ∂≤Ë∑ØÈÄ£Êé•Ë®≠ÂÇôÔºö",
                items: [
                    { label: "Ë≤†Ë≤¨È°ûÊØî/Êï∏‰ΩçË®äËôüËΩâÊèõ", answer: "Êï∏ÊìöÊ©ü" },
                    { label: "Ë≤†Ë≤¨ÂÆâÊéíË≥áÊñôÁöÑÂÇ≥ÈÄÅË∑ØÂæë", answer: "Ë∑ØÁî±Âô®" },
                    { label: "ÂèØÊì¥ÂÖÖÂÖßÈÉ®Á∂≤Ë∑ØÊé•Â≠î", answer: "Á∂≤Ë∑Ø‰∫§ÊèõÂô®" }
                ],
                options: ["Êï∏ÊìöÊ©ü", "Ë∑ØÁî±Âô®", "Á∂≤Ë∑Ø‰∫§ÊèõÂô®"],
                randomPos: true,
                shuffleOnError: true,
                isQuestionEight: true, 
                isThreeColumns: true, 
                customColorGroups: true
            }
        ];

        let currentIdx = 0;
        let userStates = {};
        let quizCheckedStatus = {}; 
        let quizPassedStatus = {}; 
        let totalChecks = 0; 
        let questionCheckCounts = {}; 
        let startTime = Date.now();
        let timerInterval = null;
        let challengeCount = 1;

        const inspirationalQuotes = [
            { en: "Connection is the energy that exists between people.", zh: "ÈÄ£ÁµêÊòØ‰∫∫Ëàá‰∫∫‰πãÈñìÂ≠òÂú®ÁöÑËÉΩÈáè„ÄÇ" },
            { en: "The internet is not just a tool; it is a community.", zh: "Á∂≤Ë∑Ø‰∏çÂè™ÊòØ‰∏ÄÂÄãÂ∑•ÂÖ∑ÔºåÂÆÉÊòØ‰∏ÄÂÄãÁ§æÁæ§„ÄÇ" },
            { en: "Technology is best when it brings people together.", zh: "ÁßëÊäÄÊúÄÁæéÂ•ΩÁöÑÊôÇÂàªÔºåÂú®ÊñºÂÆÉÂ∞á‰∫∫ÂÄëÂáùËÅöÂú®‰∏ÄËµ∑„ÄÇ" },
            { en: "The great thing about the internet is that it's a giant library.", zh: "Á∂≤Ë∑ØÊúÄÂÅâÂ§ßÁöÑÂú∞ÊñπÂú®ÊñºÂÆÉÊòØ‰∏ÄÂ∫ßÂ∑®Â§ßÁöÑÂúñÊõ∏È§®„ÄÇ" },
            { en: "Education is the most powerful weapon which you can use to change the world.", zh: "ÊïôËÇ≤ÊòØ‰Ω†ÂèØ‰ª•Áî®‰æÜÊîπËÆä‰∏ñÁïåÊúÄÂº∑Â§ßÁöÑÊ≠¶Âô®„ÄÇ" },
            { en: "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice.", zh: "Â≠∏ÁøíÁöÑËÉΩÂäõÊòØÂ§©Ë≥¶ÔºåÂ≠∏ÁøíÁöÑÊñπÊ≥ïÊòØÊäÄËÉΩÔºåËÄåÂ≠∏ÁøíÁöÑÊÑèÈ°òÂâáÊòØÈÅ∏Êìá„ÄÇ" },
            { en: "Live as if you were to die tomorrow. Learn as if you were to live forever.", zh: "ÂÉèÊòéÂ§©Â∞±ÊúÉÊ≠ªÂéªÈÇ£Ê®£ÁîüÊ¥ªÔºåÂÉèÊ∞∏ÁîüÈÇ£Ê®£Â≠∏Áøí„ÄÇ" },
            { en: "The more that you read, the more things you will know.", zh: "‰Ω†Èñ±ËÆÄÂæóË∂äÂ§öÔºåÁü•ÈÅìÁöÑ‰∫ãÊÉÖÂ∞±Ë∂äÂ§ö„ÄÇ" },
            { en: "Success is not final, failure is not fatal: it is the courage to continue that counts.", zh: "ÊàêÂäü‰∏çÊòØÁµÇÈªûÔºåÂ§±Êïó‰πü‰∏çÊòØÁµïË∑ØÔºöÁúüÊ≠£ÈáçË¶ÅÁöÑÊòØÁπºÁ∫åÂâçË°åÁöÑÂãáÊ∞£„ÄÇ" },
            { en: "Believe you can and you're halfway there.", zh: "Áõ∏‰ø°‰Ω†Ëá™Â∑±ÂÅöÂæóÂà∞Ôºå‰Ω†Â∞±Â∑≤Á∂ìÊàêÂäü‰∫Ü‰∏ÄÂçä„ÄÇ" },
            { en: "It always seems impossible until it's done.", zh: "Âú®‰∫ãÊÉÖÂÆåÊàê‰πãÂâçÔºåÂÆÉÁ∏ΩÊòØÁúã‰ºº‰∏çÂèØËÉΩ„ÄÇ" },
            { en: "Don't watch the clock; do what it does. Keep going.", zh: "‰∏çË¶Å‰∏ÄÁõ¥ÁúãËëóÊôÇÈêòÔºõË¶ÅÂÅöÊôÇÈêòÊ≠£Âú®ÂÅöÁöÑ‰∫ãÔºö‰∏çÂÅúÂú∞ÂâçÈÄ≤„ÄÇ" },
            { en: "I have not failed. I've just found 10,000 ways that won't work.", zh: "ÊàëÊ≤íÊúâÂ§±ÊïóÔºåÊàëÂè™ÊòØÁôºÁèæ‰∫Ü‰∏ÄËê¨Á®ÆË°å‰∏çÈÄöÁöÑÊñπÊ≥ï„ÄÇ" },
            { en: "Every effort is paving the way for your future self.", zh: "ÊØè‰∏ÄÂàÜÂä™ÂäõÔºåÈÉΩÊòØÂú®ÁÇ∫Êú™‰æÜÁöÑËá™Â∑±Èã™Ë∑Ø„ÄÇ" },
            { en: "Don't fear mistakes; they are the best roadmaps to the right answer.", zh: "‰∏çË¶ÅÂÆ≥ÊÄïÁäØÈåØÔºåÂõ†ÁÇ∫ÈåØË™§ÊòØÈÄöÂæÄÊ≠£Á¢∫Á≠îÊ°àÁöÑÊúÄ‰Ω≥Ë∑ØÊ®ô„ÄÇ" },
            { en: "Stay curious, keep connecting.", zh: "‰øùÊåÅÂ•ΩÂ•áÔºåÊåÅÁ∫åÈÄ£ÁµêÔºå‰∏ñÁïåÊúÉÂõ†ÁÇ∫‰Ω†ÁöÑÊé¢Á¥¢ËÄåËÆäÂæóÊõ¥Â§ß„ÄÇ" }
        ];

        window.onload = () => {
            initIndicators();
            renderQuestion();
            setupGlobalEvents();
            startTimer();
        };

        function initIndicators() {
            const container = document.getElementById('status-indicators');
            container.innerHTML = quizData.map((_, i) => `<div class="progress-circle" data-idx="${i}" onclick="goToQuestion(${i})">${i+1}</div>`).join('');
        }

        function goToQuestion(idx) {
            if (quizPassedStatus[idx]) {
                showToast("ÈÄôÈ°åÂ∑≤Á∂ìÈÅéÈóúÂõâÔºÅË´ãÊåëÊà∞ÂÖ∂‰ªñÈ°åÁõÆ„ÄÇ", "error");
                return;
            }
            saveState();
            currentIdx = idx;
            renderQuestion();
        }

        function setupGlobalEvents() {
            document.getElementById('next-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('check-btn').onclick = checkAnswer;
            document.getElementById('restart-btn').onclick = handleRestart;
        }

        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const secs = String(elapsed % 60).padStart(2, '0');
                document.getElementById('timer').innerText = `${mins}:${secs}`;
            }, 1000);
        }

        function showModal(title, message, confirmText, onConfirm, showCancel = true) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.innerText = confirmText;
            confirmBtn.onclick = () => { closeModal(); if(onConfirm) onConfirm(); };
            const cancelBtn = document.getElementById('modal-cancel-btn');
            cancelBtn.style.display = showCancel ? 'block' : 'none';
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-90'); }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0'); content.classList.add('scale-90');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function renderQuestion() {
            const container = document.getElementById('question-container');
            const q = quizData[currentIdx];
            document.getElementById('progress-text').innerText = `${currentIdx + 1} / ${quizData.length}`;
            document.getElementById('prev-btn').disabled = (currentIdx === 0);
            document.getElementById('next-btn').innerText = (currentIdx === quizData.length - 1) ? "Êü•ÁúãÁµêÊûú" : "‰∏ã‰∏ÄÈ°å";

            document.querySelectorAll('.progress-circle').forEach(c => {
                c.classList.remove('active');
                if(parseInt(c.dataset.idx) === currentIdx) c.classList.add('active');
            });

            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'fade-in';

            if (q.type === 'matching_fixed') renderMatchingFixed(q, wrapper);
            else if (q.type === 'multiple_choice') renderMultipleChoice(q, wrapper);
            else if (q.type === 'drag_and_drop_slot') renderDragAndDropSlot(q, wrapper);
            else if (q.type === 'matching_list') renderMatchingList(q, wrapper);

            container.appendChild(wrapper);
            restoreState();
            updateProgressIndicators();
        }

        function renderMatchingFixed(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-10 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);

            const flow = document.createElement('div');
            flow.className = "flex flex-row items-start justify-center w-full gap-1 max-w-5xl mx-auto";
            q.steps.forEach((step, idx) => {
                const item = document.createElement('div');
                if (step.type === 'slot') {
                    item.className = "flex-1 flex flex-col items-center drop-target-box rounded-2xl p-1";
                    item.dataset.type = "target-box";
                    item.dataset.index = idx;
                    item.dataset.answer = step.answer || "";
                    item.ondragover = handleDragOver;
                    item.ondragleave = handleDragLeave;
                    item.ondrop = handleDrop;
                } else {
                    item.className = "flex-1 flex flex-col items-center p-1";
                }
                
                const desc = document.createElement('div');
                desc.className = `text-[10px] md:text-xs text-pink-400 font-bold h-8 flex items-center justify-center pointer-events-none mb-1 text-center ${q.isQuestionFiveSix ? 'w-[92%]' : ''}`;
                desc.innerText = step.desc || "";
                item.appendChild(desc);

                if (step.type === 'fixed') {
                    const fixed = document.createElement('div');
                    let fixedClass = "fixed-block w-full h-[52px] rounded-xl font-bold text-xl whitespace-nowrap pointer-events-none flex items-center justify-center";
                    if (q.isQuestionFiveSix) {
                        if (idx === 0) fixedClass += " q56-fixed-left";
                        else fixedClass += " q56-fixed-right";
                    } else {
                        fixedClass += " bg-gray-50 text-gray-400";
                    }
                    fixed.className = fixedClass;
                    fixed.innerText = step.name;
                    item.appendChild(fixed);
                } else {
                    const slot = document.createElement('div');
                    let slotClass = "slot w-full rounded-xl border-2 text-xl bg-white";
                    if (q.isQuestionOne) slotClass += " q1-slot-style";
                    else if (q.isFixedSlotQuestion) slotClass += " q-fixed-height-slot";
                    else slotClass += " py-6"; 

                    slot.className = slotClass;
                    slot.dataset.type = "slot";
                    item.appendChild(slot);
                }
                flow.appendChild(item);
                if (idx < q.steps.length - 1) {
                    const arrowWrap = document.createElement('div');
                    arrowWrap.className = "pt-14 flex-shrink-0 text-gray-300 font-bold text-lg pointer-events-none";
                    arrowWrap.innerHTML = "‚ûú";
                    flow.appendChild(arrowWrap);
                }
            });
            wrapper.appendChild(flow);
            const currentAnswersOrder = q.steps.filter(s => s.type === 'slot').map(s => s.answer);
            renderSourceArea(q.options, wrapper, q.forceColor, false, currentAnswersOrder, q.isQuestionOne);
        }

        function renderMultipleChoice(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-10 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);
            
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto";
            
            const colorPool = shuffleArray([0, 1, 2, 3, 4, 5, 6]);
            const shuffledOptions = shuffleArray([...q.options]);
            
            shuffledOptions.forEach((opt, i) => {
                const card = document.createElement('div');
                const colorIdx = colorPool[i % colorPool.length];
                card.className = `choice-card color-${colorIdx} p-6 rounded-3xl shadow-md flex items-center justify-center gap-6`;
                card.dataset.value = opt.text;
                card.onclick = (e) => {
                    document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    saveState();
                };
                card.innerHTML = `<div class="text-5xl">${opt.icon}</div><div class="text-2xl font-bold text-gray-800">${opt.text}</div>`;
                grid.appendChild(card);
            });
            wrapper.appendChild(grid);
        }

        function renderDragAndDropSlot(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-10 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);

            const sentence = document.createElement('div');
            sentence.className = "text-xl md:text-2xl text-gray-800 leading-[4.5rem] text-left flex flex-wrap justify-start items-center gap-y-4 px-8 md:px-20";
            
            q.parts.forEach((part, i) => {
                if (part) {
                    const span = document.createElement('span');
                    span.innerText = part;
                    sentence.appendChild(span);
                }
                if (i < q.blanks.length) {
                    const targetBox = document.createElement('div');
                    targetBox.className = "drop-target-box inline-flex items-center justify-center transition-all q3-slot-inline";
                    targetBox.dataset.type = "target-box";
                    targetBox.dataset.index = i;
                    targetBox.dataset.answer = q.blanks[i];
                    targetBox.ondragover = handleDragOver;
                    targetBox.ondragleave = handleDragLeave;
                    targetBox.ondrop = handleDrop;

                    const slot = document.createElement('div');
                    slot.className = "slot q-fixed-height-slot bg-white border-2 border-dashed border-pink-200 shadow-inner w-full";
                    slot.dataset.type = "slot";
                    targetBox.appendChild(slot);
                    sentence.appendChild(targetBox);
                }
            });
            wrapper.appendChild(sentence);
            renderSourceArea(q.options, wrapper, q.forceColor, false, q.blanks);
        }

        function renderMatchingList(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-8 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);
            
            const displayItems = q.randomPos ? shuffleArray([...q.items]) : [...q.items];
            const currentAnswersOrder = displayItems.map(item => item.answer);

            const createItemBox = (item, i) => {
                const itemBox = document.createElement('div');
                let colorIdx = i % 3; 
                let colorClass = `color-${colorIdx}`;
                const isCompact = (q.isQuestionFour || q.isQuestionEight || q.isQuestionSeven);
                const boxPadding = isCompact ? "p-2 gap-1.5" : "p-5 gap-4";
                
                itemBox.className = `${colorClass} drop-target-box ${boxPadding} rounded-3xl border-2 border-white shadow-md flex flex-col items-center transition-all h-full w-full`;
                itemBox.dataset.type = "target-box";
                const originalIndex = q.items.findIndex(orig => orig.label === item.label);
                itemBox.dataset.index = originalIndex;
                itemBox.dataset.answer = item.answer;
                itemBox.ondragover = handleDragOver;
                itemBox.ondragleave = handleDragLeave;
                itemBox.ondrop = handleDrop;

                const label = document.createElement('div');
                if (isCompact) {
                    const alignClass = q.isQuestionSeven ? "text-left justify-start px-4" : "text-center justify-center";
                    label.className = `text-xl font-black text-gray-800 bg-white/30 pointer-events-none flex items-center q-compact-label ${alignClass}`;
                } else {
                    label.className = "text-lg font-black text-gray-800 text-center px-2 py-1 bg-white/30 rounded-lg pointer-events-none leading-relaxed flex-grow flex items-center";
                }
                label.innerText = item.label;
                itemBox.appendChild(label);

                const slot = document.createElement('div');
                const slotClass = isCompact ? "slot q-fixed-height-slot bg-white/80 border-none text-xl shadow-inner width-[92%]" : "slot w-full rounded-2xl py-5 bg-white/80 border-none text-xl shadow-inner";
                slot.className = slotClass;
                slot.dataset.type = "slot";
                itemBox.appendChild(slot);
                return itemBox;
            };

            if (q.isQuestionFour) {
                const splitIdx = 3;
                const topGrid = document.createElement('div');
                topGrid.className = "grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto mb-6 justify-items-center";
                displayItems.slice(0, 3).forEach((item, i) => topGrid.appendChild(createItemBox(item, i)));
                wrapper.appendChild(topGrid);
                renderSourceArea(q.options, wrapper, true, q.customColorGroups, currentAnswersOrder, false);
                const bottomGrid = document.createElement('div');
                bottomGrid.className = "grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto mt-6 justify-items-center";
                displayItems.slice(3, 6).forEach((item, i) => bottomGrid.appendChild(createItemBox(item, i + 3)));
                wrapper.appendChild(bottomGrid);
            } else {
                const list = document.createElement('div');
                list.className = q.isThreeColumns ? "grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto mb-10 justify-items-center" : "grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto mb-10 justify-items-center";
                displayItems.forEach((item, i) => list.appendChild(createItemBox(item, i)));
                wrapper.appendChild(list);
                renderSourceArea(q.options, wrapper, true, q.customColorGroups, currentAnswersOrder);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const box = e.currentTarget;
            box.classList.remove('drag-over');
            const elId = e.dataTransfer.getData("text/plain");
            const el = document.getElementById(elId);
            if (!el) return;
            if (box.id === 'source-area') {
                el.style.width = ""; el.style.height = "";
                box.appendChild(el);
            } else {
                const slot = box.querySelector('.slot') || (box.dataset.type === 'slot' ? box : null);
                if (slot) {
                    const existing = slot.querySelector('.macaron-btn');
                    if (existing) {
                        existing.style.width = ""; existing.style.height = "";
                        document.getElementById('source-area').appendChild(existing);
                    }
                    if (quizData[currentIdx].isQuestionFiveSix) {
                        el.style.width = "100%"; el.style.height = "100%";
                    }
                    slot.appendChild(el);
                }
            }
            saveState();
        }

        function renderSourceArea(options, wrapper, forceColor, useGroups = false, forbiddenOrder = null, isQ1 = false) {
            const sourceArea = document.createElement('div');
            sourceArea.className = "my-4 p-8 bg-pink-50/30 rounded-3xl border-2 border-dashed border-pink-100 flex flex-wrap justify-center gap-4 min-h-[100px]";
            sourceArea.id = "source-area";
            sourceArea.dataset.type = "source";
            sourceArea.ondragover = e => e.preventDefault();
            sourceArea.ondrop = handleDrop;
            let shuffled = shuffleArray([...options]);
            if (forbiddenOrder && shuffled.length > 1 && shuffled.length === forbiddenOrder.length) {
                let attempts = 0;
                while (attempts < 10) { 
                    const isMatch = shuffled.every((val, index) => val === forbiddenOrder[index]);
                    if (!isMatch) break;
                    shuffled = shuffleArray([...shuffled]);
                    attempts++;
                }
            }
            shuffled.forEach((opt, idx) => {
                let colorIdx;
                if (useGroups) colorIdx = (idx % 3) + 3; 
                else colorIdx = forceColor ? options.indexOf(opt) % 7 : idx % 7;
                sourceArea.appendChild(createDragElement(opt, colorIdx, isQ1));
            });
            wrapper.appendChild(sourceArea);
        }

        function createDragElement(text, colorIdx, isQ1 = false) {
            const el = document.createElement('div');
            const baseClass = `macaron-btn color-${colorIdx} rounded-xl shadow-md font-bold text-gray-700 border-2 border-white/50 text-xl whitespace-nowrap`;
            el.className = isQ1 ? baseClass + " q1-btn-style" : baseClass + " px-6 py-2 w-fit";
            el.innerText = text;
            el.id = "opt-" + Math.random().toString(36).substr(2, 9);
            el.draggable = true;
            el.dataset.value = text;
            el.ondragstart = e => { 
                e.dataTransfer.setData("text/plain", el.id); 
                e.target.style.opacity = "0.5"; 
            };
            el.ondragend = e => { e.target.style.opacity = "1"; };
            return el;
        }

        function saveState() {
            const q = quizData[currentIdx];
            const state = { values: {} };
            if (q.type === 'multiple_choice') {
                const selected = document.querySelector('.choice-card.selected');
                if (selected) state.selected = selected.dataset.value;
            } else {
                document.querySelectorAll('.drop-target-box').forEach(box => {
                    const item = box.querySelector('.macaron-btn');
                    if (item) state.values[box.dataset.index] = { id: item.id, val: item.dataset.value };
                });
            }
            userStates[currentIdx] = state;
        }

        function restoreState() {
            const state = userStates[currentIdx];
            if (!state) return;
            const q = quizData[currentIdx];
            if (q.type === 'multiple_choice') {
                if (state.selected) {
                    const card = document.querySelector(`.choice-card[data-value="${state.selected}"]`);
                    if (card) card.classList.add('selected');
                }
            } else {
                Object.keys(state.values).forEach(idx => {
                    const el = document.getElementById(state.values[idx].id);
                    const box = document.querySelector(`.drop-target-box[data-index="${idx}"]`);
                    if (el && box) {
                        const slot = box.querySelector('.slot');
                        if (slot) {
                            if (q.isQuestionFiveSix) { el.style.width = "100%"; el.style.height = "100%"; }
                            slot.appendChild(el);
                        }
                    }
                });
            }
        }

        function navigate(dir) {
            saveState();
            if (dir > 0 && !quizCheckedStatus[currentIdx]) {
                showModal("Ê∫´È¶®ÊèêÈÜí", "ÊÇ®ÈÄôÈ°åÈÇÑÊ≤íÈªûÊìä„ÄéÊ™¢Êü•Á≠îÊ°à„ÄèÂñîÔºÅË¶ÅÂÖàÊ™¢Êü•ÁúãÁúãÂóéÔºü", "Áõ¥Êé•ÂâçÂæÄ‰∏ã‰∏ÄÈ°å", () => performNavigation(dir));
                return;
            }
            performNavigation(dir);
        }

        function performNavigation(dir) {
            if (dir > 0 && currentIdx === quizData.length - 1) {
                showFinalSummary();
            } else if (dir > 0 && currentIdx + dir < quizData.length) {
                currentIdx += dir; renderQuestion();
            } else if (dir < 0) {
                currentIdx += dir; renderQuestion();
            }
        }

        function checkAnswer() {
            const q = quizData[currentIdx];
            let incomplete = false;
            if (q.type === 'multiple_choice') {
                const selected = userStates[currentIdx]?.selected;
                if (!selected) { showToast("Ë´ãÈÅ∏Êìá‰∏ÄÂÄãÁ≠îÊ°àÂñîÔºÅ", "error"); return; }
                quizCheckedStatus[currentIdx] = true;
                totalChecks++;
                questionCheckCounts[currentIdx] = (questionCheckCounts[currentIdx] || 0) + 1;
                if (selected !== q.correct) { 
                    showToast(`ÈÇÑÂ∑Æ‰∏ÄÈªûÈªûÔºåÂä†Ê≤πÔºÅÈÅ∏È†Ö‰ΩçÁΩÆËàáÈ°èËâ≤Â∑≤ÈáçÊñ∞Êõ¥Êèõ„ÄÇ`, "error"); 
                    delete userStates[currentIdx];
                    setTimeout(() => renderQuestion(), 800);
                }
                else { handleSuccess(); }
            } else {
                const boxes = document.querySelectorAll('.drop-target-box');
                boxes.forEach(box => { if (!box.querySelector('.macaron-btn')) incomplete = true; });
                if (incomplete) { showToast("ÈÇÑÊúâÁ©∫Ê†ºÊ≤íÂ°´ÂÆåÂñîÔºÅË´ãÂÆåÊàêÂæåÂÜçÊ™¢Êü•„ÄÇ", "error"); return; }
                quizCheckedStatus[currentIdx] = true;
                totalChecks++;
                questionCheckCounts[currentIdx] = (questionCheckCounts[currentIdx] || 0) + 1;
                let errors = 0;
                boxes.forEach(box => {
                    const item = box.querySelector('.macaron-btn');
                    if (item.dataset.value !== box.dataset.answer) { errors++; box.classList.add('error-hint'); setTimeout(() => box.classList.remove('error-hint'), 1500); }
                    else { box.classList.add('correct-hint'); setTimeout(() => box.classList.remove('correct-hint'), 1500); }
                });
                if (errors === 0) { handleSuccess(); }
                else {
                    showToast(`ÈÇÑÂ∑Æ‰∏ÄÈªûÈªûÔºåÁ≠îÊ°àÂ∞áÈáçÊñ∞Ê≠∏‰ΩçÔºÅ`, "error");
                    if (q.shuffleOnError) { setTimeout(() => { delete userStates[currentIdx]; renderQuestion(); }, 1200); }
                }
            }
        }

        function handleSuccess() {
            showToast("üéâ Â§™Ê£í‰∫ÜÔºÅÂÖ®ÈÉ®Ê≠£Á¢∫ÔºÅÁ≥ªÁµ±Â∞áË∑≥‰∏ã‰∏ÄÈ°å„ÄÇ", "success");
            quizPassedStatus[currentIdx] = true;
            updateProgressIndicators();
            if (quizData[currentIdx].type === 'multiple_choice') {
                const winCard = document.querySelector('.choice-card.selected');
                if(winCard) winCard.classList.add('winner-anim');
            }
            setTimeout(() => { performNavigation(1); }, 600);
        }

        function updateProgressIndicators() {
            document.querySelectorAll('.progress-circle').forEach(circle => {
                if (quizPassedStatus[parseInt(circle.dataset.idx)]) circle.classList.add('passed');
            });
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full text-white font-bold transition-all z-[600] text-xl shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-gray-800'}`;
            toast.style.opacity = "1";
            setTimeout(() => toast.style.opacity = "0", 2500);
        }

        function handleRestart() {
            const correctCount = Object.keys(quizPassedStatus).length;
            if (correctCount === quizData.length) {
                showModal("Ë∂ÖÂº∑ÊåëÊà∞ËÄÖÔºÅ", "ÊÇ®Â∑≤Á∂ìÂÖ®Â∞ç‰∫ÜÔºÅÂú®ÈáçÁΩÆ‰πãÂâçÔºåÊÇ®ÊúâÊà™Âúñ‰øùÂ≠òÈÄô‰ªΩÂÖâÊ¶ÆÁöÑÁµêÊûúÂóéÔºü", "Á¢∫Ë™çÈáçÁΩÆÊåëÊà∞", restartQuiz);
            } else {
                showModal("ÈáçÊñ∞ÈñãÂßãÊ∏¨È©óÔºü", "ÊÇ®Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÁõÆÂâçÁöÑ‰ΩúÁ≠îÈÄ≤Â∫¶‰∏¶ÈáçÊñ∞ÈñãÂßãÊ∏¨È©óÂóéÔºü", "Á¢∫Ë™çÈáçÁΩÆ", restartQuiz);
            }
        }

        function restartQuiz() {
            userStates = {}; quizPassedStatus = {}; quizCheckedStatus = {}; totalChecks = 0; questionCheckCounts = {}; currentIdx = 0;
            challengeCount++; 
            document.getElementById('result-overlay').classList.add('hidden');
            document.querySelectorAll('.progress-circle').forEach(c => c.classList.remove('passed'));
            renderQuestion();
            startTimer();
        }

        function generateRandomId() {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const l = letters[Math.floor(Math.random() * 26)];
            const r1 = Math.floor(Math.random() * 10); 
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            return `H${l}${r1}-${d}${h}.${m}`;
        }

        async function showFinalSummary() {
            clearInterval(timerInterval);
            const timerText = document.getElementById('timer').innerText;
            const correctCount = Object.keys(quizPassedStatus).length;
            const quote = inspirationalQuotes[Math.floor(Math.random() * inspirationalQuotes.length)];
            const randomId = generateRandomId();
            
            document.getElementById('display-random-id').innerText = `Á∑®Ëôü: ${randomId}`;
            
            const breakdownText = quizData.map((_, i) => `Q${i+1}:${questionCheckCounts[i] || 0}`).join(', ');

            document.getElementById('final-stats').innerHTML = `
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-pink-50 p-3 rounded-2xl text-center"><p class="text-gray-400 text-[10px]">Á∏ΩÈ°åÊï∏</p><p class="text-2xl font-black text-pink-600">${quizData.length}</p></div>
                    <div class="bg-green-50 p-3 rounded-2xl text-center"><p class="text-gray-400 text-[10px]">Á≠îÂ∞çÈ°åÊï∏</p><p class="text-2xl font-black text-green-600">${correctCount}</p></div>
                    <div class="bg-blue-50 p-3 rounded-2xl text-center"><p class="text-gray-400 text-[10px]">ÊåëÊà∞Ê¨°Êï∏</p><p class="text-2xl font-black text-blue-600">${challengeCount}</p></div>
                </div>
                <div class="text-center p-2">
                    <p class="text-sm text-gray-500 font-bold">Á∏ΩÁî®ÊôÇÔºö<span class="text-pink-500 font-bold">${timerText}</span> | Á∏ΩÊ™¢Êü•Ôºö<span class="text-pink-500 font-bold">${totalChecks}</span> Ê¨°</p>
                </div>`;

            const breakdownContainer = document.getElementById('check-breakdown');
            breakdownContainer.innerHTML = quizData.map((_, i) => {
                const count = questionCheckCounts[i] || 0;
                return `<div class="flex flex-col items-center bg-gray-50 p-2 rounded-xl border border-gray-100"><span class="text-[10px] text-gray-400 font-bold">Q${i+1}</span><span class="text-lg font-black ${count > 1 ? 'text-orange-400' : 'text-sky-400'}">${count}</span></div>`;
            }).join('');

            document.getElementById('quote-zh').innerText = quote.zh;
            document.getElementById('quote-en').innerText = quote.en;
            document.getElementById('result-overlay').classList.remove('hidden');

            if (gasUrl) {
                const payload = {
                    randomId: randomId,
                    challengeCount: challengeCount,
                    totalQuestions: quizData.length,
                    correctAnswers: correctCount,
                    totalTime: timerText,
                    totalChecks: totalChecks,
                    breakdown: breakdownText
                };
                try {
                    fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) { console.error("Data submission failed", e); }
            }
        }
    </script>
</body>
</html>