<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9ä¸‹2-1.1èªè­˜ç¶²è·¯(ç¶²è·¯çš„é€£æ¥)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --macaron-pink: #FFB7B2;
            --macaron-orange: #FFDAC1;
            --macaron-yellow: #FFF9B1;
            --macaron-green: #B5EAD7;
            --macaron-blue: #C7CEEA;
            --macaron-purple: #E0BBE4;
            --macaron-mint: #E2F0CB;
        }

        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #fff1f2; /* ç²‰ç´…é¦¬å¡é¾èƒŒæ™¯ */
            overflow-x: hidden;
        }

        .main-card {
            max-width: 1000px;
            min-height: 85vh;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(244, 114, 182, 0.1);
        }

        /* æ ¸å¿ƒäº’å‹•ä¿®æ­£ï¼šç¢ºä¿æ–¹å¡Šæœ¬èº«å¯é»æ“Šï¼Œä½†å…§éƒ¨æ–‡å­—ä¸å¹²æ“¾ */
        .macaron-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: grab;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            pointer-events: auto !important; /* å¼·åˆ¶æ–¹å¡Šå¯è¢«æŠ“å– */
        }
        
        .macaron-btn * {
            pointer-events: none; /* é˜²æ­¢å…§éƒ¨æ–‡å­—å¹²æ“¾æ‹–æ›³ */
        }

        .macaron-btn:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .slot {
            transition: all 0.3s ease;
            min-height: 3.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            background: white;
            border: 2px dashed rgba(0, 0, 0, 0.05);
            font-weight: bold;
            position: relative;
            pointer-events: none; /* è®“ç©ºæ§½ä½ä¸é˜»æ“‹ Drop äº‹ä»¶å‚³çµ¦çˆ¶å±¤ TargetBox */
        }

        .drop-target-box {
            transition: all 0.3s ease;
            position: relative;
            pointer-events: auto; /* ç¢ºä¿æ„Ÿæ‡‰å€å¯æ¥æ”¶ Drop */
        }
        
        .drop-target-box.drag-over {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            filter: brightness(1.05);
        }

        /* æŒ‰éˆ•å…¨å€åŸŸé»æ“Šåˆ¤å®š */
        button, .choice-card, .progress-circle {
            pointer-events: auto;
        }
        button *, .choice-card *, .progress-circle * {
            pointer-events: none;
        }

        /* é¡è‰²é¡åˆ¥ */
        .color-0 { background-color: var(--macaron-pink); }
        .color-1 { background-color: var(--macaron-orange); }
        .color-2 { background-color: var(--macaron-yellow); }
        .color-3 { background-color: var(--macaron-green); }
        .color-4 { background-color: var(--macaron-blue); }
        .color-5 { background-color: var(--macaron-purple); }
        .color-6 { background-color: var(--macaron-mint); }
        
        .fixed-block { background-color: #f3f4f6; border: 2px solid #e5e7eb; display: inline-flex; justify-content: center; align-items: center; }

        .correct-hint { border: 4px solid #4ade80 !important; }
        .error-hint { border: 4px solid #f87171 !important; animation: shake 0.4s ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.4s ease;
            background-color: white;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
            cursor: pointer;
        }
        .progress-circle:hover { border-color: #f472b6; color: #f472b6; }
        .progress-circle.active { border-color: #f472b6; background-color: #fff1f2; color: #f472b6; transform: scale(1.1); }
        .progress-circle.passed {
            background-color: #f472b6;
            border-color: #f472b6;
            color: white;
            box-shadow: 0 4px 10px rgba(244, 114, 182, 0.2);
        }

        .choice-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .choice-card:hover { transform: translateY(-5px); }
        .choice-card.selected { border-color: #f472b6; background-color: #fff1f2; }
        
        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1); }
        }
        .winner-anim { animation: celebrate 0.5s ease infinite; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="quiz-app" class="main-card bg-white w-full flex flex-col relative overflow-hidden">
        
        <header class="p-6 md:p-8 flex flex-wrap gap-4 justify-between items-center bg-pink-50/50">
            <div class="flex flex-col">
                <div class="flex items-center flex-wrap gap-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-pink-500 text-balance">ğŸŒ 9ä¸‹2-1.1èªè­˜ç¶²è·¯(ç¶²è·¯çš„é€£æ¥)</h1>
                    <div id="status-indicators" class="flex gap-2 ml-2"></div>
                </div>
                <p class="text-gray-400 text-sm mt-1">ä½œç­”é€²åº¦: <span id="progress-text" class="font-bold text-pink-400"></span></p>
            </div>
            <div id="timer" class="text-xl font-bold text-gray-600 bg-white px-4 py-1 rounded-full shadow-sm">00:00</div>
        </header>

        <main id="question-container" class="flex-grow p-6 md:p-10 overflow-y-auto">
            <!-- é¡Œç›®ç”± JS æ³¨å…¥ -->
        </main>

        <footer class="p-6 md:p-8 bg-gray-50 flex flex-wrap gap-4 justify-between items-center relative z-[200]">
            <button id="prev-btn" class="px-6 py-2 rounded-full border-2 border-pink-200 text-pink-400 font-bold hover:bg-pink-100 disabled:opacity-30 transition-all">
                ä¸Šä¸€é¡Œ
            </button>
            
            <div class="flex items-center gap-4">
                <button id="check-btn" class="px-8 py-3 bg-pink-500 text-white rounded-full font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-all active:scale-95">
                    æª¢æŸ¥ç­”æ¡ˆ
                </button>
                <button id="next-btn" class="px-6 py-2 rounded-full bg-indigo-400 text-white font-bold hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-100">
                    ä¸‹ä¸€é¡Œ
                </button>
            </div>
        </footer>

        <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[300] flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform scale-90 transition-transform duration-300" id="modal-content">
                <div class="text-4xl mb-4 text-center" id="modal-icon">ğŸ’¡</div>
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 text-center mb-2">æé†’</h3>
                <p id="modal-message" class="text-gray-600 text-center mb-6 leading-relaxed"></p>
                <div class="flex gap-4 justify-center">
                    <button id="modal-cancel-btn" onclick="closeModal()" class="px-6 py-2 border-2 border-gray-200 text-gray-400 font-bold rounded-full hover:bg-gray-50 transition-all active:scale-95">è¿”å›</button>
                    <button id="modal-confirm-btn" class="px-6 py-2 bg-pink-500 text-white font-bold rounded-full hover:bg-pink-600 transition-all active:scale-95 shadow-lg shadow-pink-100">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <div id="result-overlay" class="absolute inset-0 bg-white z-[500] flex flex-col items-center justify-center p-6 md:p-10 hidden fade-in overflow-y-auto">
            <div class="border-4 border-pink-200 rounded-3xl p-8 max-w-3xl w-full bg-white shadow-xl my-8">
                <h2 class="text-3xl font-bold text-pink-500 mb-6 text-center text-balance">ğŸ“ æ¸¬é©—æŒ‘æˆ°çµæœ</h2>
                <div id="final-stats" class="space-y-4 mb-8"></div>
                <div class="bg-pink-50 p-6 rounded-2xl mb-8 text-center border border-pink-100">
                    <div id="quote-zh" class="text-xl font-bold text-pink-600 mb-3 text-balance"></div>
                    <div id="quote-en" class="text-base italic text-pink-400 leading-relaxed text-balance"></div>
                </div>
                <div class="flex justify-center">
                    <button onclick="handleRestart()" class="px-12 py-4 bg-pink-500 text-white rounded-full text-xl font-bold shadow-xl hover:bg-pink-600 transition-all active:scale-95">é‡æ–°æŒ‘æˆ°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full bg-gray-800 text-white font-bold opacity-0 transition-opacity pointer-events-none z-[600] text-xl shadow-lg"></div>

    <script>
        // æ´—ç‰Œæ¼”ç®—æ³•
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        const quizData = [
            {
                type: 'matching_fixed',
                question: "è«‹æ ¹æ“šç¶²è·¯ç™¼å±•å²ï¼Œç”±é åˆ°è¿‘æ’åˆ—æ­£ç¢ºçš„é †åºï¼š",
                options: ["ARPANET", "TCP/IP", "ç¶²åŸŸåç¨±æœå‹™", "WWW+ç€è¦½å™¨", "TANet"],
                steps: [
                    { type: 'slot', answer: "ARPANET", desc: "ç¶²éš›ç¶²è·¯é››å½¢" },
                    { type: 'slot', answer: "TCP/IP", desc: "å…±åŒé€šè¨Šèªè¨€" },
                    { type: 'slot', answer: "ç¶²åŸŸåç¨±æœå‹™", desc: "IPè½‰æ˜“è¨˜ç¶²å€" },
                    { type: 'slot', answer: "WWW+ç€è¦½å™¨", desc: "åœ–å½¢åŒ–ä»‹é¢æ™®åŠ" },
                    { type: 'slot', answer: "TANet", desc: "è‡ºç£å­¸è¡“ç¶²è·¯" }
                ],
                forceColor: true,
                shuffleOnError: true 
            },
            {
                type: 'multiple_choice',
                question: "è«‹å•èª°ç™¼æ˜äº†å…¨çƒè³‡è¨Šç¶²èˆ‡ç¶²é ç€è¦½å™¨ï¼Ÿ",
                correct: "æŸç´ï¼æ",
                options: [
                    { text: "æŸç´ï¼æ", icon: "ğŸŒ" },
                    { text: "æ¯”çˆ¾ï¼è“‹èŒ²", icon: "ğŸ’»" },
                    { text: "ä¼Šéš†Â·é¦¬æ–¯å…‹", icon: "ğŸš€" },
                    { text: "é¦¬å…‹Â·ç¥–å…‹æŸ", icon: "ğŸ‘¥" }
                ],
                theme: "pink"
            },
            {
                type: 'drag_and_drop',
                question: "[__]æ˜¯é€éæœ‰ç·šæˆ–ç„¡ç·šçš„[__]ï¼Œå°‡è¨±å¤šé›»è…¦æˆ–ç¡¬é«”è¨­å‚™[__]èµ·ä¾†ï¼Œè®“å½¼æ­¤å¯ä»¥äº’ç›¸[__]çš„æŠ€è¡“ã€‚",
                blanks: ["ç¶²è·¯", "å‚³è¼¸åª’ä»‹", "é€£æ¥", "å‚³éè³‡è¨Š"],
                options: ["ç¶²è·¯", "å‚³è¼¸åª’ä»‹", "é€£æ¥", "å‚³éè³‡è¨Š"],
                forceColor: true,
                shuffleOnError: true
            },
            {
                type: 'matching_list',
                question: "è«‹å°‡ä¸‹åˆ—ä¸­è‹±æ–‡åè©é€²è¡Œæ­£ç¢ºé…å°ï¼š",
                items: [
                    { label: "ç¶²è·¯", answer: "Network" },
                    { label: "å…¨çƒç¬¬ä¸€å€‹ç¶²è·¯", answer: "ARPANET" },
                    { label: "ç¶²è·¯é€šè¨Šå”å®š", answer: "TCP/IP" },
                    { label: "å…¨çƒè³‡è¨Šç¶²ç°¡ç¨±", answer: "WWW" },
                    { label: "è‡ºç£å­¸è¡“ç¶²è·¯", answer: "TANet" },
                    { label: "ç¶²è·¯æœå‹™æä¾›è€…", answer: "ISP" }
                ],
                options: ["Network", "ARPANET", "TCP/IP", "WWW", "TANet", "ISP"],
                randomPos: true,
                customColorGroups: true,
                shuffleOnError: true
            },
            {
                type: 'matching_fixed',
                question: "è«‹ç”±ã€Œæ…¢ã€åˆ°ã€Œå¿«ã€æ’åˆ—æœ‰ç·šå‚³è¼¸åª’ä»‹é€Ÿåº¦ï¼š",
                options: ["é›™çµç·š", "åŒè»¸é›»çºœç·š", "å…‰çº–"],
                steps: [
                    { type: 'fixed', name: "æ…¢" },
                    { type: 'slot', answer: "é›™çµç·š" },
                    { type: 'slot', answer: "åŒè»¸é›»çºœç·š" },
                    { type: 'slot', answer: "å…‰çº–" },
                    { type: 'fixed', name: "å¿«" }
                ],
                forceColor: true,
                shuffleOnError: true
            },
            {
                type: 'matching_fixed',
                question: "è«‹ä¾å‚³è¼¸è·é›¢ã€Œé ã€åˆ°ã€Œè¿‘ã€æ’åˆ—æœ‰ç·šå‚³è¼¸åª’ä»‹ï¼š",
                options: ["å…‰çº–", "åŒè»¸é›»çºœç·š", "é›™çµç·š"],
                steps: [
                    { type: 'fixed', name: "é " },
                    { type: 'slot', answer: "å…‰çº–" },
                    { type: 'slot', answer: "åŒè»¸é›»çºœç·š" },
                    { type: 'slot', answer: "é›™çµç·š" },
                    { type: 'fixed', name: "è¿‘" }
                ],
                forceColor: true,
                shuffleOnError: true
            },
            {
                type: 'matching_list',
                question: "è«‹æ ¹æ“šç’°å¢ƒèªªæ˜é¸æ“‡é©åˆçš„å‚³è¼¸åª’ä»‹ï¼š",
                items: [
                    { label: "æœ‹å‹å€Ÿä½å®¶è£¡äºŒæ¨“å…©å¤©ï¼Œæœ‰ä¸Šç¶²çš„éœ€æ±‚ï¼Œä½†äºŒæ¨“æ²’æœ‰ç¶²è·¯ï¼Œæœ€è¿‘çš„ç¶²è·¯è¨­å‚™åœ¨ä¸‰æ¨“ï¼Œé€Ÿåº¦ä¸è¦æ±‚ï¼Œå¯ä»¥ä¸Šç¶²å°±å¥½", answer: "é›™çµç·š" },
                    { label: "å·¥å» è¾¦å…¬å®¤äººå¤ªå¤šåä¸ä¸‹ï¼Œåœ¨ç›´ç·š50å…¬å°ºè™•ï¼Œæ–°å¢ä¸€é–“è¾¦å…¬å®¤ï¼Œæƒ³ä¸²é€£èˆŠè¾¦å…¬å®¤çš„ç¶²è·¯ï¼Œä½ˆç·šè·¯å¾‘æœƒç¶“éå¾ˆå¤šé«˜åŠŸç‡çš„æ©Ÿå™¨", answer: "åŒè»¸é›»çºœç·š" },
                    { label: "å…‰å¾©åœ‹ä¸­æ“å ´çš„å¸ä»¤å°æƒ³è¦å®‰æ’ä¸€å€‹å¿«é€Ÿåˆç©©å®šçš„æœ‰ç·šç¶²è·¯ç¯€é»ï¼Œä½†æœ€è¿‘çš„ç¶²è·¯è¨­å‚™åœ¨é›»è…¦æ•™å®¤", answer: "å…‰çº–" }
                ],
                options: ["é›™çµç·š", "åŒè»¸é›»çºœç·š", "å…‰çº–"],
                randomPos: true,
                shuffleOnError: true,
                isThreeColumns: true, 
                customColorGroups: true
            },
            {
                type: 'matching_list',
                question: "è«‹æ ¹æ“šåŠŸèƒ½èªªæ˜ï¼Œé…å°æ­£ç¢ºçš„ç¶²è·¯é€£æ¥è¨­å‚™ï¼š",
                items: [
                    { label: "è² è²¬é¡æ¯”/æ•¸ä½è¨Šè™Ÿè½‰æ›", answer: "æ•¸æ“šæ©Ÿ" },
                    { label: "è² è²¬å®‰æ’è³‡æ–™çš„å‚³é€è·¯å¾‘", answer: "è·¯ç”±å™¨" },
                    { label: "å¯æ“´å……å…§éƒ¨ç¶²è·¯æ¥å­”", answer: "ç¶²è·¯äº¤æ›å™¨" }
                ],
                options: ["æ•¸æ“šæ©Ÿ", "è·¯ç”±å™¨", "ç¶²è·¯äº¤æ›å™¨"],
                randomPos: true,
                shuffleOnError: true,
                isThreeColumns: true, 
                customColorGroups: true
            }
        ];

        const inspirationalQuotes = [
            { en: "Connection is the energy that exists between people.", zh: "é€£çµæ˜¯äººèˆ‡äººä¹‹é–“å­˜åœ¨çš„èƒ½é‡ã€‚" },
            { en: "Believe you can and you're halfway there.", zh: "æˆåŠŸæ˜¯æ¯å¤©åè¦†åŠªåŠ›çš„å°æˆæœç©ç´¯è€Œæˆçš„ã€‚" },
            { en: "Stay curious, keep connecting.", zh: "ä¿æŒå¥½å¥‡ï¼ŒæŒçºŒé€£çµã€‚" }
        ];

        let currentIdx = 0;
        let userStates = {};
        let quizCheckedStatus = {}; 
        let quizPassedStatus = {}; 
        let totalChecks = 0; 
        let startTime = Date.now();
        let timerInterval = null;

        window.onload = () => {
            initIndicators();
            renderQuestion();
            setupGlobalEvents();
            startTimer();
        };

        function initIndicators() {
            const container = document.getElementById('status-indicators');
            container.innerHTML = quizData.map((_, i) => `<div class="progress-circle" data-idx="${i}" onclick="goToQuestion(${i})">${i+1}</div>`).join('');
        }

        function goToQuestion(idx) {
            saveState();
            currentIdx = idx;
            renderQuestion();
        }

        function setupGlobalEvents() {
            document.getElementById('next-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('check-btn').onclick = checkAnswer;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const secs = String(elapsed % 60).padStart(2, '0');
                document.getElementById('timer').innerText = `${mins}:${secs}`;
            }, 1000);
        }

        function showModal(title, message, confirmText, onConfirm, showCancel = true) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.innerText = confirmText;
            confirmBtn.onclick = () => { closeModal(); if(onConfirm) onConfirm(); };
            const cancelBtn = document.getElementById('modal-cancel-btn');
            cancelBtn.style.display = showCancel ? 'block' : 'none';
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-90'); }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0'); content.classList.add('scale-90');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function renderQuestion() {
            const container = document.getElementById('question-container');
            const q = quizData[currentIdx];
            document.getElementById('progress-text').innerText = `${currentIdx + 1} / ${quizData.length}`;
            document.getElementById('prev-btn').disabled = (currentIdx === 0);
            document.getElementById('next-btn').innerText = (currentIdx === quizData.length - 1) ? "æŸ¥çœ‹çµæœ" : "ä¸‹ä¸€é¡Œ";

            document.querySelectorAll('.progress-circle').forEach(c => {
                c.classList.remove('active');
                if(parseInt(c.dataset.idx) === currentIdx) c.classList.add('active');
            });

            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'fade-in';

            if (q.type === 'matching_fixed') renderMatchingFixed(q, wrapper);
            else if (q.type === 'multiple_choice') renderMultipleChoice(q, wrapper);
            else if (q.type === 'drag_and_drop') renderDragAndDrop(q, wrapper);
            else if (q.type === 'matching_list') renderMatchingList(q, wrapper);

            container.appendChild(wrapper);
            restoreState();
            updateProgressIndicators();
        }

        function renderMatchingFixed(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-10 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);
            const flow = document.createElement('div');
            flow.className = "flex flex-wrap justify-center gap-4 items-start";
            
            q.steps.forEach((step, idx) => {
                const item = document.createElement('div');
                if (step.type === 'slot') {
                    item.className = "flex flex-col items-center gap-1 drop-target-box rounded-2xl p-2";
                    item.dataset.type = "target-box";
                    item.dataset.index = idx;
                    item.dataset.answer = step.answer || "";
                    item.ondragover = handleDragOver;
                    item.ondragleave = handleDragLeave;
                    item.ondrop = handleDrop;
                } else {
                    item.className = "flex flex-col items-center gap-1 p-2";
                }

                const desc = document.createElement('p');
                desc.className = "text-xs text-pink-400 font-bold h-6 pointer-events-none";
                desc.innerText = step.desc || "";
                item.appendChild(desc);

                if (step.type === 'fixed') {
                    const fixed = document.createElement('div');
                    fixed.className = "fixed-block px-5 py-5 rounded-xl font-bold text-gray-400 text-xl bg-gray-50 whitespace-nowrap pointer-events-none";
                    fixed.innerText = step.name;
                    item.appendChild(fixed);
                } else {
                    const slot = document.createElement('div');
                    slot.className = "slot px-4 py-6 rounded-xl border-2 text-xl bg-white min-w-[120px]";
                    slot.dataset.type = "slot";
                    item.appendChild(slot);
                }
                flow.appendChild(item);
                if (idx < q.steps.length - 1) {
                    const arrowWrap = document.createElement('div');
                    arrowWrap.className = "pt-12 hidden md:block pointer-events-none";
                    arrowWrap.innerHTML = "<span class='text-gray-300 font-bold text-xl'>âœ</span>";
                    flow.appendChild(arrowWrap);
                }
            });
            wrapper.appendChild(flow);
            
            const currentAnswersOrder = q.steps.filter(s => s.type === 'slot').map(s => s.answer);
            renderSourceArea(q.options, wrapper, q.forceColor, false, currentAnswersOrder);
        }

        function renderMultipleChoice(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-10 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto";
            
            const shuffledOptions = shuffleArray([...q.options]);
            
            shuffledOptions.forEach((opt, i) => {
                const card = document.createElement('div');
                card.className = `choice-card bg-white border-4 border-white p-6 rounded-3xl shadow-sm flex items-center justify-center gap-6 hover:bg-pink-50`;
                card.dataset.value = opt.text;
                card.onclick = (e) => {
                    document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected', 'border-pink-300'));
                    e.currentTarget.classList.add('selected', 'border-pink-300');
                    saveState();
                };
                card.innerHTML = `<div class="text-5xl">${opt.icon}</div><div class="text-2xl font-bold text-gray-700">${opt.text}</div>`;
                grid.appendChild(card);
            });
            wrapper.appendChild(grid);
        }

        function renderDragAndDrop(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-12 leading-relaxed text-left px-8 flex flex-wrap items-center gap-x-2 gap-y-4";
            const parts = q.question.split('[__]');
            parts.forEach((part, i) => {
                const pNode = document.createElement('span');
                pNode.innerText = part;
                title.appendChild(pNode);
                if (i < parts.length - 1) {
                    const targetBox = document.createElement('div');
                    targetBox.className = "drop-target-box inline-flex items-center justify-center min-w-[120px] px-2 py-1 border-b-4 border-pink-200 bg-pink-50/20 rounded-t-lg transition-all";
                    targetBox.dataset.type = "target-box";
                    targetBox.dataset.index = i;
                    targetBox.dataset.answer = q.blanks[i];
                    targetBox.ondragover = handleDragOver;
                    targetBox.ondragleave = handleDragLeave;
                    targetBox.ondrop = handleDrop;

                    const slot = document.createElement('div');
                    slot.className = "slot w-full";
                    slot.dataset.type = "slot";
                    targetBox.appendChild(slot);
                    title.appendChild(targetBox);
                }
            });
            wrapper.appendChild(title);
            renderSourceArea(q.options, wrapper, q.forceColor, false, q.blanks);
        }

        function renderMatchingList(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-10 text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);
            
            const list = document.createElement('div');
            list.className = q.isThreeColumns ? "grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto" : "grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto";
            
            const displayItems = q.randomPos ? shuffleArray([...q.items]) : [...q.items];
            const currentAnswersOrder = displayItems.map(item => item.answer);
            
            displayItems.forEach((item, i) => {
                const itemBox = document.createElement('div');
                let colorIdx = i % 3; 
                let colorClass = `color-${colorIdx}`;
                
                if (q.isThreeColumns) {
                    itemBox.className = `${colorClass} drop-target-box p-5 rounded-3xl border-2 border-white shadow-md flex flex-col items-center gap-4 transition-all w-full h-full`;
                    itemBox.dataset.type = "target-box";
                    const originalIndex = q.items.findIndex(orig => orig.label === item.label);
                    itemBox.dataset.index = originalIndex;
                    itemBox.dataset.answer = item.answer;
                    itemBox.ondragover = handleDragOver;
                    itemBox.ondragleave = handleDragLeave;
                    itemBox.ondrop = handleDrop;

                    const label = document.createElement('div');
                    label.className = "text-lg font-black text-gray-800 text-center px-2 py-1 bg-white/30 rounded-lg pointer-events-none leading-relaxed flex-grow flex items-center";
                    label.innerText = item.label;
                    itemBox.appendChild(label);

                    const slot = document.createElement('div');
                    slot.className = "slot w-full rounded-2xl py-5 bg-white/80 border-none text-xl shadow-inner";
                    slot.dataset.type = "slot";
                    itemBox.appendChild(slot);
                } else {
                    itemBox.className = `${colorClass} drop-target-box p-5 pt-3 pb-4 rounded-3xl border-2 border-white shadow-sm flex flex-col gap-2 transition-all hover:scale-[1.02]`;
                    itemBox.dataset.type = "target-box";
                    const originalIndex = q.items.findIndex(orig => orig.label === item.label);
                    itemBox.dataset.index = originalIndex;
                    itemBox.dataset.answer = item.answer;
                    itemBox.ondragover = handleDragOver;
                    itemBox.ondragleave = handleDragLeave;
                    itemBox.ondrop = handleDrop;

                    const label = document.createElement('div');
                    label.className = "text-xl font-black text-center text-gray-800 text-balance min-h-[3rem] flex items-center justify-center pointer-events-none";
                    label.innerText = item.label;
                    itemBox.appendChild(label);
                    const slot = document.createElement('div');
                    slot.className = "slot w-full rounded-2xl py-4 bg-white/90 border-none text-xl shadow-inner";
                    slot.dataset.type = "slot";
                    itemBox.appendChild(slot);
                }
                list.appendChild(itemBox);
            });
            wrapper.appendChild(list);
            renderSourceArea(q.options, wrapper, true, q.customColorGroups, currentAnswersOrder);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const box = e.currentTarget;
            box.classList.remove('drag-over');
            
            const elId = e.dataTransfer.getData("text/plain");
            const el = document.getElementById(elId);
            if (!el) return;

            // åˆ¤å®šæ‰è½åœ°é»æ˜¯ Slot é‚„æ˜¯ SourceArea
            if (box.id === 'source-area') {
                box.appendChild(el);
            } else {
                const slot = box.querySelector('.slot') || (box.dataset.type === 'slot' ? box : null);
                if (slot) {
                    const existing = slot.querySelector('.macaron-btn');
                    if (existing) document.getElementById('source-area').appendChild(existing);
                    slot.appendChild(el);
                }
            }
            saveState();
        }

        function renderSourceArea(options, wrapper, forceColor, useGroups = false, forbiddenOrder = null) {
            const sourceArea = document.createElement('div');
            sourceArea.className = "mt-12 p-8 bg-pink-50/30 rounded-3xl border-2 border-dashed border-pink-100 flex flex-wrap justify-center gap-4 min-h-[100px]";
            sourceArea.id = "source-area";
            sourceArea.dataset.type = "source";
            sourceArea.ondragover = e => e.preventDefault();
            sourceArea.ondrop = handleDrop;
            
            let shuffled = shuffleArray([...options]);
            
            if (forbiddenOrder && shuffled.length > 1 && shuffled.length === forbiddenOrder.length) {
                let attempts = 0;
                while (attempts < 10) { 
                    const isMatch = shuffled.every((val, index) => val === forbiddenOrder[index]);
                    if (!isMatch) break;
                    shuffled = shuffleArray([...shuffled]);
                    attempts++;
                }
            }
            
            shuffled.forEach((opt, idx) => {
                let colorIdx;
                if (useGroups) {
                    colorIdx = (idx % 3) + 3; 
                } else {
                    colorIdx = forceColor ? options.indexOf(opt) % 7 : idx % 7;
                }
                sourceArea.appendChild(createDragElement(opt, colorIdx));
            });
            wrapper.appendChild(sourceArea);
        }

        function createDragElement(text, colorIdx) {
            const el = document.createElement('div');
            el.className = `macaron-btn color-${colorIdx} px-6 py-2 rounded-xl shadow-md font-bold text-gray-700 border-2 border-white/50 text-xl whitespace-nowrap`;
            el.innerText = text;
            el.id = "opt-" + Math.random().toString(36).substr(2, 9);
            el.draggable = true;
            el.dataset.value = text;
            el.ondragstart = e => { 
                e.dataTransfer.setData("text/plain", el.id); 
                e.target.style.opacity = "0.5"; 
            };
            el.ondragend = e => { 
                e.target.style.opacity = "1"; 
            };
            return el;
        }

        function saveState() {
            const q = quizData[currentIdx];
            const state = { values: {} };
            if (q.type === 'multiple_choice') {
                const selected = document.querySelector('.choice-card.selected');
                if (selected) state.selected = selected.dataset.value;
            } else {
                document.querySelectorAll('.drop-target-box').forEach(box => {
                    const item = box.querySelector('.macaron-btn');
                    if (item) state.values[box.dataset.index] = { id: item.id, val: item.dataset.value };
                });
            }
            userStates[currentIdx] = state;
        }

        function restoreState() {
            const state = userStates[currentIdx];
            if (!state) return;
            const q = quizData[currentIdx];
            if (q.type === 'multiple_choice') {
                if (state.selected) {
                    const card = document.querySelector(`.choice-card[data-value="${state.selected}"]`);
                    if (card) card.classList.add('selected', 'border-pink-300');
                }
            } else {
                Object.keys(state.values).forEach(idx => {
                    const el = document.getElementById(state.values[idx].id);
                    const box = document.querySelector(`.drop-target-box[data-index="${idx}"]`);
                    if (el && box) {
                        const slot = box.querySelector('.slot');
                        if (slot) slot.appendChild(el);
                    }
                });
            }
        }

        function navigate(dir) {
            saveState();
            if (dir > 0 && !quizCheckedStatus[currentIdx]) {
                showModal("æº«é¦¨æé†’", "æ‚¨é€™é¡Œé‚„æ²’é»æ“Šã€æª¢æŸ¥ç­”æ¡ˆã€å–”ï¼è¦å…ˆæª¢æŸ¥çœ‹çœ‹å—ï¼Ÿ", "ç›´æ¥å‰å¾€ä¸‹ä¸€é¡Œ", () => performNavigation(dir));
                return;
            }
            performNavigation(dir);
        }

        function performNavigation(dir) {
            if (dir > 0 && currentIdx + dir < quizData.length) {
                currentIdx += dir;
                renderQuestion();
            } else if (dir < 0) {
                currentIdx += dir;
                renderQuestion();
            } else if (dir > 0 && currentIdx === quizData.length - 1) {
                showFinalSummary();
            }
        }

        function checkAnswer() {
            const q = quizData[currentIdx];
            let incomplete = false;

            if (q.type === 'multiple_choice') {
                const selected = userStates[currentIdx]?.selected;
                if (!selected) { 
                    showToast("è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆå–”ï¼", "error"); 
                    return; 
                }
                quizCheckedStatus[currentIdx] = true;
                totalChecks++;
                if (selected !== q.correct) {
                    showToast(`é‚„å·®ä¸€é»é»ï¼ŒåŠ æ²¹ï¼`, "error");
                } else {
                    showToast("ğŸ‰ å¤ªæ£’äº†ï¼å…¨éƒ¨æ­£ç¢ºï¼", "success");
                    quizPassedStatus[currentIdx] = true;
                    const winCard = document.querySelector('.choice-card.selected');
                    winCard.classList.add('winner-anim');
                    updateProgressIndicators();
                    setTimeout(() => winCard.classList.remove('winner-anim'), 2000);
                }
            } else {
                const boxes = document.querySelectorAll('.drop-target-box');
                
                boxes.forEach(box => {
                    const item = box.querySelector('.macaron-btn');
                    if (!item) incomplete = true;
                });

                if (incomplete) {
                    showToast("é‚„æœ‰ç©ºæ ¼æ²’å¡«å®Œå–”ï¼è«‹å®Œæˆå¾Œå†æª¢æŸ¥ã€‚", "error");
                    return; 
                }

                quizCheckedStatus[currentIdx] = true;
                totalChecks++;
                let errors = 0;
                boxes.forEach(box => {
                    const item = box.querySelector('.macaron-btn');
                    if (item.dataset.value !== box.dataset.answer) {
                        errors++;
                        box.classList.add('error-hint');
                        setTimeout(() => box.classList.remove('error-hint'), 1500);
                    } else {
                        box.classList.add('correct-hint');
                        setTimeout(() => box.classList.remove('correct-hint'), 1500);
                    }
                });

                if (errors === 0) {
                    showToast("ğŸ‰ å¤ªæ£’äº†ï¼å…¨éƒ¨æ­£ç¢ºï¼", "success");
                    quizPassedStatus[currentIdx] = true;
                    updateProgressIndicators();
                } else {
                    showToast(`é‚„å·®ä¸€é»é»ï¼Œç­”æ¡ˆå°‡é‡æ–°æ­¸ä½ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼`, "error");
                    if (q.shuffleOnError) {
                        setTimeout(() => {
                            delete userStates[currentIdx];
                            renderQuestion();
                            showToast("åµæ¸¬åˆ°éŒ¯èª¤ï¼Œç³»çµ±å·²é‡æ–°æ´—ç‰Œï¼", "error");
                        }, 1200);
                    }
                }
            }
        }

        function updateProgressIndicators() {
            document.querySelectorAll('.progress-circle').forEach(circle => {
                if (quizPassedStatus[parseInt(circle.dataset.idx)]) circle.classList.add('passed');
            });
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full text-white font-bold transition-all z-[600] text-xl shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-gray-800'}`;
            toast.style.opacity = "1";
            setTimeout(() => toast.style.opacity = "0", 2500);
        }

        function handleRestart() {
            let correctCount = Object.keys(quizPassedStatus).length;
            if (correctCount === quizData.length) {
                showModal("è¶…å¼·æŒ‘æˆ°è€…ï¼", "æ‚¨å·²ç¶“å…¨å°äº†ï¼åœ¨é‡ç½®ä¹‹å‰ï¼Œæ‚¨æœ‰æˆªåœ–ä¿å­˜é€™ä»½å…‰æ¦®çš„çµæœå—ï¼Ÿ", "ç¢ºèªé‡ç½®æŒ‘æˆ°", restartQuiz);
            } else {
                restartQuiz();
            }
        }

        function restartQuiz() {
            userStates = {};
            quizPassedStatus = {};
            quizCheckedStatus = {};
            totalChecks = 0;
            currentIdx = 0;
            document.getElementById('result-overlay').classList.add('hidden');
            document.querySelectorAll('.progress-circle').forEach(c => c.classList.remove('passed'));
            renderQuestion();
            startTimer();
        }

        function showFinalSummary() {
            clearInterval(timerInterval);
            const timerText = document.getElementById('timer').innerText;
            let correctCount = Object.keys(quizPassedStatus).length;
            const quote = inspirationalQuotes[Math.floor(Math.random() * inspirationalQuotes.length)];
            document.getElementById('quote-zh').innerText = quote.zh;
            document.getElementById('quote-en').innerText = quote.en;
            document.getElementById('final-stats').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-pink-50 p-4 rounded-2xl text-center"><p class="text-gray-400 text-sm">ç¸½é¡Œæ•¸</p><p class="text-3xl font-black text-pink-600">${quizData.length}</p></div>
                    <div class="bg-green-50 p-4 rounded-2xl text-center"><p class="text-gray-400 text-sm">ç­”å°é¡Œæ•¸</p><p class="text-3xl font-black text-green-600">${correctCount}</p></div>
                </div>
                <div class="text-center p-4">
                    <p class="text-lg text-gray-500">ç¸½ç”¨æ™‚ï¼š<span class="text-pink-500 font-bold">${timerText}</span> | æª¢æŸ¥æ¬¡æ•¸ï¼š<span class="text-pink-500 font-bold">${totalChecks}</span></p>
                </div>`;
            document.getElementById('result-overlay').classList.remove('hidden');
        }
    </script>
</body>
</html>